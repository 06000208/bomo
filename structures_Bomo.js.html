<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>structures/Bomo.js - Documentation</title>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <span class="navicon"></span>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="API.html">API</a></li><li><a href="Base.html">Base</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Base.html#bomo">bomo</a></li><li data-type='member'><a href="Base.html#createdAt">createdAt</a></li><li data-type='member'><a href="Base.html#createdTimestamp">createdTimestamp</a></li><li data-type='member'><a href="Base.html#id">id</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="Base.html#toJSON">toJSON</a></li><li data-type='method'><a href="Base.html#toObject">toObject</a></li></ul></li><li><a href="Bomo.html">Bomo</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Bomo.html#app">app</a></li><li data-type='member'><a href="Bomo.html#auth">auth</a></li><li data-type='member'><a href="Bomo.html#public">public</a></li><li data-type='member'><a href="Bomo.html#rooms">rooms</a></li><li data-type='member'><a href="Bomo.html#server">server</a></li><li data-type='member'><a href="Bomo.html#users">users</a></li><li data-type='member'><a href="Bomo.html#wss">wss</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="Bomo.html#start">start</a></li><li data-type='method'><a href="Bomo.html#stop">stop</a></li></ul></li><li><a href="Chat.html">Chat</a></li><li><a href="Client.html">Client</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Client.html#authorization">authorization</a></li><li data-type='member'><a href="Client.html#chat">chat</a></li><li data-type='member'><a href="Client.html#expires">expires</a></li><li data-type='member'><a href="Client.html#id">id</a></li><li data-type='member'><a href="Client.html#ws">ws</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="Client.html#connect">connect</a></li><li data-type='method'><a href="Client.html#register">register</a></li></ul></li><li><a href="Color.html">Color</a></li><li><a href="Game.html">Game</a></li><li><a href="Methods.html">Methods</a></li><li><a href="Player.html">Player</a></li><li><a href="Room.html">Room</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Room.html#leaders">leaders</a></li><li data-type='member'><a href="Room.html#members">members</a></li><li data-type='member'><a href="Room.html#name">name</a></li></ul></li><li><a href="RoomBrowser.html">RoomBrowser</a></li><li><a href="User.html">User</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="User.html#auth">auth</a></li><li data-type='member'><a href="User.html#lastOnline">lastOnline</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="User.html#toObject">toObject</a></li></ul></li><li><a href="WebSocketEvents.html">WebSocketEvents</a><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="WebSocketEvents.html#.serverOnConnection">serverOnConnection</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-generateRandomHex.html">generateRandomHex</a><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-generateRandomHex.html#~generateRandomHex">generateRandomHex</a></li></ul></li><li><a href="module-log.html">log</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="module-log.html#~timestamp">timestamp</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-log.html#~log">log</a></li><li data-type='method'><a href="module-log.html#~print">print</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-process.html">process</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="external-process.html#.env">env</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">structures/Bomo.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { log } from "../util/log.js";
import { Room } from "./Room.js";
import { WebSocketEvents } from "./WebSocketEvents.js";
import EventEmitter from "node:events";
import { join, dirname } from "node:path";
import { fileURLToPath } from "node:url";
import chalk from "chalk";
import ejs from "ejs";
import sirv from "sirv";
import { cookieParser } from "@tinyhttp/cookie-parser";
import { App } from "@tinyhttp/app";
import { WebSocketServer } from "ws";
import { createHash } from "node:crypto";

const loggingColors = {
    "1": chalk.gray, // Informational responses
    "2": chalk.cyan, // Successful responses
    "3": chalk.gray, // Redirects
    "4": chalk.yellow, // Client errors
    "5": chalk.magenta, // Server errors
};

/**
 * Bomo's core class. Named Bomo rather than app to differentiate from tinyhttp's App
 * @extends {EventEmitter}
 */
class Bomo extends EventEmitter {
    /**
     * Setting engine, parsing cookie headers, logging middleware, 404 route, and serving the public folder are handled by Bomo's constructor
     */
    constructor() {
        super();

        /**
         * Path of the publicly served folder. Used with sirv.
         */
        this.public = join(dirname(fileURLToPath(import.meta.url)), "../public");

        /**
         * Currently available rooms mapped to their ids
         * @type {Map&lt;string, Room>}
         */
        this.rooms = new Map();

        /**
         * Users mapped to their ids
         * @type {Map&lt;string, Room>}
         */
        this.users = new Map();

        /**
         * Valid base64 encoded authorization strings mapped to user ids
         * @type {Map&lt;string, string>}
         */
        this.auth = new Map();

        // Check if the port environment variable is valid
        /** @todo Not checking number validity yet, just falsy, which works because empty strings are falsy */
        if (!process.env.port) throw new TypeError("PORT environment variable must be a valid number");

        /**
         * Tinyhttp App w/ ejs templating engine
         * @see https://tinyhttp.v1rtl.site/docs#application
         * @see https://ejs.co/#docs
         * @type {App}
         */
        this.app = new App({
            noMatchHandler: (req, res) => {
                res.status(404);
                // respond with html page
                if (req.accepts("html")) {
                    res.render("404.ejs", {
                        title: `${process.env.title} - 404`,
                        icon: "/error.ico",
                        url: req.url,
                    });
                    return;
                }
                // respond with json
                if (req.accepts("json")) {
                    res.json({
                        "code": 404,
                        "status": "404 Not Found",
                        "message": `The requested resource "${req.url}" was not found`,
                    });
                    return;
                }
                // default to plain text
                res.type("txt").send("404 Not Found");
            },
            onError: (err, req, res) => {
                log.error(req.ip || req.socket.remoteAddress, req.method, req.originalUrl || req.url, err);
                res.status(500).json({
                    "code": 500,
                    "status": "500 Internal Server Error",
                    "message": err.message,
                });
            },
        });

        // Engine
        this.app.engine("ejs", ejs.renderFile);

        // Parse cookie headers via cookie-parser
        this.app.use(cookieParser());

        // Provide hashed ip address on all requests
        // this.app.use((req, res, next) => {
        //     /** @todo Should support X-Forwarded-For header but only while actually behind a proxy, as otherwise its vulnerable to spoofing */
        //     req.addressHash = createHash("sha256").update(req.ip || req.socket.remoteAddress).digest("hex");
        //     next();
        // });

        // Logging middleware via /util/log
        this.app.use((req, res, next) => {
            res.on("finish", () => {
                const code = res.statusCode.toString();
                const url = req.originalUrl || req.url;
                const args = [req.ip || req.socket.remoteAddress, req.method, loggingColors[code[0]](code), res.statusMessage, url];
                /** @todo Some homework would be figuring out how to args.push() the JSON body of requests and responses if present on either */
                // Not currently using cookies anywhere
                // if (url === "/") args.push("Cookies:", JSON.stringify(req.cookies));
                const message = args.join(" ").trim();
                if (code[0] === "4" || code[0] === "5") {
                    log.debug(message);
                } else {
                    log.trace(message);
                }
            });
            next();
        });

        // Static webserver using sirv serving the public folder
        // https://www.npmjs.com/package/sirv
        this.app.use("/", sirv(this.public, {
            dev: process.env.dev === "true",
            maxAge: 86400, // Cached for 24 hours
        }));

        /**
         * The http.Server returned by tinyhttp's App.listen()
         *
         * This will be null until Bomo.start() is called
         * @see https://github.com/tinyhttp/tinyhttp/blob/a9e00dcaa93f2e38f7a68e3301f7cd97dea69270/packages/app/src/app.ts#L354
         * @see https://nodejs.org/api/http.html#http_http_createserver_options_requestlistener
         * @type {?http.Server}
         */
        this.server = null;

        /**
         * Websocket server using ws
         *
         * Notes:
         *
         * - This is an implementation of a real websocket library, so the preferred equivalent client side is the browser's own WebSocket implementation
         * - I couldn't find documentation for CommonJS usage of ws, but destructuring Server as WebSocketServer works fine
         * - This will be null until created by Bomo.start() in order to use the same internal http server as tinyhttp
         * @see https://github.com/websockets/ws/blob/HEAD/doc/ws.md
         * @see https://www.npmjs.com/package/ws
         * @see https://developer.mozilla.org/en-US/docs/Web/API/WebSocket
         * @type {?WebSocketServer}
         */
        this.wss = null;
    }

    /**
     * Starts bomo
     */
    start() {
        // Create http server &amp; make tinyhttp listen
        this.server = this.app.listen(Number(process.env.port), () => {
            // callback after server starts listening
            log.info(`${chalk.green("[READY]")} tinyhttp listening on port ${process.env.port}`);
        });

        // Create websocket server using pre-existing http server
        this.wss = new WebSocketServer({
            clientTracking: true,
            path: "/ws",
            server: this.server,
        });

        // Add websocket server events
        this.wss.on("connection", WebSocketEvents.serverOnConnection.bind(null, this));

        /** @todo Possibly move this to the wss listening event? */
        log.info(`${chalk.green("[READY]")} Websocket server ready to upgrade connections`);
    }

    /**
     * Stops bomo
     * @todo Reading the ws documentation, it doesn't look like this could easily await wss.close()
     */
    stop() {
        // this.wss.close();
        process.exit(0);
    }

    // /**
    //  * Creates a room
    //  * @returns {Room} - Returns the room created
    //  */
    // createRoom() {
    //     return new Room(this);
    // }
}

export { Bomo };
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc" target="_blank">JSDoc 3.6.7</a> on 1/31/2022 using the <a href="https://github.com/Grafluxe/boxy-jsdoc-template" target="_blank">boxy-jsdoc-template</a> theme.
</footer>

<script src="scripts/prettify/prettify.js"></script>
<script src="scripts/prettify/lang-css.js"></script>
<script src="scripts/script.js"></script>

</body>
</html>
