<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>index.js - Documentation</title>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <span class="navicon"></span>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="API.html">API</a></li><li><a href="Base.html">Base</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Base.html#bomo">bomo</a></li><li data-type='member'><a href="Base.html#createdAt">createdAt</a></li><li data-type='member'><a href="Base.html#createdTimestamp">createdTimestamp</a></li><li data-type='member'><a href="Base.html#id">id</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="Base.html#toJSON">toJSON</a></li><li data-type='method'><a href="Base.html#toObject">toObject</a></li></ul></li><li><a href="Bomo.html">Bomo</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Bomo.html#app">app</a></li><li data-type='member'><a href="Bomo.html#auth">auth</a></li><li data-type='member'><a href="Bomo.html#public">public</a></li><li data-type='member'><a href="Bomo.html#rooms">rooms</a></li><li data-type='member'><a href="Bomo.html#server">server</a></li><li data-type='member'><a href="Bomo.html#users">users</a></li><li data-type='member'><a href="Bomo.html#wss">wss</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="Bomo.html#start">start</a></li><li data-type='method'><a href="Bomo.html#stop">stop</a></li></ul></li><li><a href="Chat.html">Chat</a></li><li><a href="Client.html">Client</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Client.html#authorization">authorization</a></li><li data-type='member'><a href="Client.html#chat">chat</a></li><li data-type='member'><a href="Client.html#expires">expires</a></li><li data-type='member'><a href="Client.html#id">id</a></li><li data-type='member'><a href="Client.html#ws">ws</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="Client.html#connect">connect</a></li><li data-type='method'><a href="Client.html#register">register</a></li></ul></li><li><a href="Color.html">Color</a></li><li><a href="Game.html">Game</a></li><li><a href="Methods.html">Methods</a></li><li><a href="Player.html">Player</a></li><li><a href="Room.html">Room</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="Room.html#leaders">leaders</a></li><li data-type='member'><a href="Room.html#members">members</a></li><li data-type='member'><a href="Room.html#name">name</a></li></ul></li><li><a href="RoomBrowser.html">RoomBrowser</a></li><li><a href="User.html">User</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="User.html#auth">auth</a></li><li data-type='member'><a href="User.html#lastOnline">lastOnline</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="User.html#toObject">toObject</a></li></ul></li><li><a href="WebSocketEvents.html">WebSocketEvents</a><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="WebSocketEvents.html#.serverOnConnection">serverOnConnection</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-generateRandomHex.html">generateRandomHex</a><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-generateRandomHex.html#~generateRandomHex">generateRandomHex</a></li></ul></li><li><a href="module-log.html">log</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="module-log.html#~timestamp">timestamp</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-log.html#~log">log</a></li><li data-type='method'><a href="module-log.html#~print">print</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-process.html">process</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="external-process.html#.env">env</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @todo This is gradually going to become outdated, right? Maybe we aught get rid of it */
/*
# Tentative Structure
    /public/ (Files served static accessible to browsers/client)
        /assets/
        /css/
        /js/ (Client side javascript not using ES6 modules)
            main.js (unused code, mainly chat stuff, color was moved to modules/structures/)
        /modules/ (Used for client side ES6 modules)
            /structures/ (Used for classes)
                Chat.js
                Client.js (Client side app)
                Color.js (unused &amp; unfinished code)
            index.js (Client side code)
    /structures/ (Used for classes)
        Base.js (Reusable abstract class)
        Bomo.js (Server side app)
        Game.js (Game logic, completely unfinished)
        Player.js (Dunno what this is)
        Room.js (Class representing rooms)
        User.js (Class representing users)
    /views/ (Rendered ejs templates)
        /partials/ (ejs files injected other templates)
        404.ejs
        browser.ejs (Unused code, don't touch)
        index.ejs (Central application, intending on using single page application design)
        old-index.ejs (Not in the repo, unused old code, don't touch)
        standard.ejs (Template using the standard partials, may be copy pasted for new pages)
        test.ejs (Testing page)
    index.js
*/

// const fs = require("fs");
// const path = require("path");
// const Bomo = require("./structures/Bomo");
// const User = require("./structures/User");
// const API = require("./structures/API");
// const log = require("./util/log");

import fs from "node:fs";
import { join, dirname } from "node:path";
import { fileURLToPath } from "node:url";
import { rateLimit } from "@tinyhttp/rate-limit";
import { log } from "./util/log.js";
import { User } from "./structures/User.js";
import { Bomo } from "./structures/Bomo.js";

log.info("Starting bomo...");

// node.js process event listeners
// See https://nodejs.org/api/process.html for more information
process.on("uncaughtException", (err, origin) => {
    log.fatal(`${origin},`, err);
    return process.exit(1); // Always let code exit on uncaught exceptions
});
process.on("unhandledRejection", (reason, promise) => log.error(`unhandledRejection\n`, promise));
process.on("rejectionHandled", (promise) => log.debug("rejectionHandled\n", promise));
process.on("warning", (warning) => log.warn(warning));
process.on("exit", (code) => code === 0 ? log.info("Exiting peacefully") : log.warn("Exiting abnormally with code:", code));

// Environment file setup
const envPath = join(dirname(fileURLToPath(import.meta.url)), ".env");
const envTemplate = join(dirname(fileURLToPath(import.meta.url)), "template.env");
if (!fs.existsSync(envPath)) {
    log.info("No .env file present, copying template...");
    fs.copyFileSync(envTemplate, envPath);
}

/**
 * Information and control over the current Node.js process
 * @external process
 * @see https://nodejs.org/docs/latest/api/process.html
 */

/**
 * Environment variables
 * @see https://nodejs.org/docs/latest/api/process.html#process_process_env
 * @see https://www.npmjs.com/package/dotenv
 * @name env
 * @type {Object}
 * @readonly
 * @memberof external:process
 */

const initialize = async function() {
    // Populate environment variables
    await import("./util/env.js");

    // const { rateLimit } = await import("@tinyhttp/rate-limit");

    // Instantiate bomo
    // Setting engine, parsing cookie headers, logging middleware, 404 route, and serving the public folder are handled by Bomo's constructor
    const bomo = new Bomo();

    /**
     * Authorization header validation
     * @param {*} req - Request
     * @param {*} res - Response
     * @param {function} next - Next function
     * @todo not sure where this should go, simplest would be right here
     * @todo Check bomo.auth.has() with the authorization header
     * @todo Return 403 forbidden for requests with invalid authorization headers
     * @todo Would be nice to handle 401 unauthorized and send it with the proper WWW-Authenticate header https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401
     */
    const validate = async function(req, res, next) {
        // if (!req.get("Authorization")) {}
        // const authorization = Buffer.from(req.get("Authorization"), "base64").toString("utf8");
        log.trace("Validating authorization header from", req.ip || req.socket.remoteAddress);
        next();
    };

    // Register api routes with tinyhttp
    // bomo.app.get("/time", (req, res, next) => res.json({ content: DateTime.now().toFormat("HH:mm:ss.SSS") }));
    // bomo.app.post("/time", (req, res, next) => res.json({
    //     message: "yes i can here u are",
    //     content: DateTime.now().toFormat("HH:mm:ss.SSS"),
    // }));

    /**
     * Creates a new user with authorization details
     */
    bomo.app.post("/api/users",
        /** @todo Couldn't decide on a good rate limit */
        // rateLimit({ max: 8, windowMs: 10000 /* 10 seconds */ }),
        (req, res, next) => {
            const user = new User(bomo, req.ip || req.socket.remoteAddress);
            res.status(201).json({
                content: user.toObject(),
            });
        },
    );

    /**
     * Retrieves user info
     */
    bomo.app.get("/api/users/:id",
        /** @todo Couldn't decide on a good rate limit */
        /** @todo Needs to use the authorization middleware */
        /** @todo Are the returns after Response.json() nesscary? */
        /** @todo Returning 404 is arguably dumb, and different stack overflow questions have completely different answers debating it, but 204 No Content can't have a body (?) */
        async (req, res, next) => {
            if (!req.params.id || !bomo.users.has(req.params.id)) {
                res.status(404).json({
                    "code": 404,
                    "status": "404 Not Found",
                    "message": `User "${req.params.id}" not found`,
                });
                return;
            }
            const user = bomo.users.get(req.params.id);
            const data = user.toObject();
            // Important to strip certain details from the object if the user shouldn't have them
            if (user.auth.encoded !== req.get("Authorization")) delete data.authorization;
            res.status(200).json({
                content: data,
            });
        },
    );

    /**
     * Route that will always return 200 OK content: true
     */
    bomo.app.get("/api/test/true", (req, res, next) => res.status(200).json({ content: true }));

    /**
     * Route to test rate limiting
     */
    bomo.app.get("/api/test/limit",
        rateLimit({ max: 10, windowMs: 60000 /* 1 minute */ }),
        (req, res, next) => res.status(200).json({ content: true }),
    );

    /**
     * Route to test authentication
     * @todo No validation middleware yet
     */
    bomo.app.get("/api/test/auth",
        // Validation middleware
        (req, res, next) => res.status(200).json({ content: true }),
    );

    // // Lobby API Endpoints
    // bomo.app.post("/api/lobby/create", (req, res, next) => {
    //     // params: name, some sort of browser/session id
    //     // returns: success, lobby code
    // });

    // bomo.app.post("/api/lobby/join", (req, res, next) => {
    //     // params: name, some sort of browser/session id, lobby code
    //     // returns: success
    // });

    // Register page routes with tinyhttp
    bomo.app.get("/", (req, res, next) => res.render("index.ejs", {
        title: process.env.title,
        icon: "/favicon.ico",
        node_version: process.version,
    }));
    // bomo.app.get("/test", (req, res, next) => res.render("test.ejs", {
    //     title: `${process.env.title} - api test`,
    //     icon: "/favicon.ico",
    // }));

    // Start
    bomo.start();
};

initialize();
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc" target="_blank">JSDoc 3.6.7</a> on 1/31/2022 using the <a href="https://github.com/Grafluxe/boxy-jsdoc-template" target="_blank">boxy-jsdoc-template</a> theme.
</footer>

<script src="scripts/prettify/prettify.js"></script>
<script src="scripts/prettify/lang-css.js"></script>
<script src="scripts/script.js"></script>

</body>
</html>
